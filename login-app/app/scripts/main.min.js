$(() => {

  const API_PATH = 'https://nsk.execution.su:8446/pwa2/api/';
  const LS_TOKEN_KEY = 'token-pwa2';

  $('#login-form').hide();
  $('#userinfo-form').hide();

  function showLogin() {
    $('#login-form').show();
    $('#userinfo-form').hide();
  }

  function showUserInfo() {
    $('#login-form').hide();
    $('#userinfo-form').show();
  }

  function showUserInfoOrLogin() {
    $.ajax({
      url: `${API_PATH}userinfo`,
      data: {
        token: localStorage.getItem(LS_TOKEN_KEY),
      },
      success(userInfo) {
        showUserInfo();
      },
      error() {
        showLogin();
      }
    });
  }

  $('#login-button').click(evt => {
    evt.preventDefault();
    $.ajax({
      url: `${API_PATH}login`,
      data: {
        login: $('#login-input').val(),
        password: $('#password-input').val(),
      },
      success(token) {
        $('#login-result').html('')
        localStorage.setItem(LS_TOKEN_KEY, token);
        showUserInfoOrLogin();
      },
      error(res) {
        if (res.status === 404) {
          $('#login-result').html('<span>User not registered</span>')
          return;
        }
        if (res.status === 401) {
          $('#login-result').html('<span>Wrong password</span>')
          return;
        }
        $('#login-result').html('<span>Unknown error</span>')
      }
    });
  });

  $('#logout-button').click(evt => {
    evt.preventDefault();
    localStorage.setItem(LS_TOKEN_KEY, '');
    showLogin();
  });

  showUserInfoOrLogin();
});
