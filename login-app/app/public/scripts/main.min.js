$(() => {

  $('#login-form').hide();
  $('#userinfo-form').hide();

  function showLogin() {
    $('#login-form').show();
    $('#userinfo-form').hide();
  }

  function showUserInfo() {
    $('#login-form').hide();
    $('#userinfo-form').show();
  }

  function showUserInfoOrLogin() {
    $.ajax({
      url: 'https://nsk.execution.su:8446/api/userinfo',
      data: {
        token: localStorage.getItem('token'),
      },
      success(userInfo) {
        showUserInfo();
      },
      error() {
        showLogin();
      }
    });
  }

  $('#login-button').click(evt => {
    evt.preventDefault();
    $.ajax({
      url: 'https://nsk.execution.su:8446/api/login',
      data: {
        login: $('#login-input').val(),
        password: $('#password-input').val(),
      },
      success(token) {
        $('#login-result').html('')
        localStorage.setItem('token', token);
        showUserInfoOrLogin();
      },
      error(res) {
        if (res.status === 404) {
          $('#login-result').html('<span>User not registered</span>')
          return;
        }
        if (res.status === 401) {
          $('#login-result').html('<span>Wrong password</span>')
          return;
        }
        $('#login-result').html('<span>Unknown error</span>')
      }
    });
  });

  $('#logout-button').click(evt => {
    evt.preventDefault();
    localStorage.setItem('token', '');
    showLogin();
  });

  showUserInfoOrLogin();
});
